name: Build Linux Executable

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          qt6-base-dev \
          qt6-base-dev-tools \
          qt6-svg-dev \
          python3-dev \
          python3-pybind11 \
          libspdlog-dev \
          nlohmann-json3-dev \
          libgtest-dev

    - name: Build and install QWT for Qt6
      run: |
        git clone https://git.code.sf.net/p/qwt/git qwt
        cd qwt
        git checkout qwt-6.3
        qmake6 qwt.pro
        make -j$(nproc)
        sudo make install
        sudo mkdir -p /usr/local/lib/pkgconfig
        sudo ln -sf /usr/local/qwt-6.3.1-dev/lib/pkgconfig/Qt6Qwt6.pc /usr/local/lib/pkgconfig/Qt6Qwt6.pc

    - name: Build and install dime
      run: |
        git clone https://github.com/coin3d/dime.git
        cd dime
        mkdir build
        cd build
        cmake ..
        cmake --build . -j$(nproc)
        sudo make install

    - name: Build with CMake
      uses: threeal/cmake-action@v2.1.0
      with:
        generator: Ninja
        build-dir: build
        options: CMAKE_BUILD_TYPE=Release

    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure
      continue-on-error: true

    - name: Setup AppDir structure
      run: |
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        cp build/TurnLab AppDir/usr/bin/
        chmod +x AppDir/usr/bin/TurnLab

    - name: Create desktop file
      run: |
        cat > AppDir/usr/share/applications/turnlab.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=TurnLab
        Comment=CNC Turning Software
        Exec=TurnLab
        Icon=turnlab
        Categories=Development;Engineering;
        Terminal=false
        EOF

    - name: Create AppImage icon
      run: |
        if [ -f res/icons/app-icon.png ]; then
          cp res/icons/app-icon.png AppDir/usr/share/icons/hicolor/256x256/apps/turnlab.png
        else
          # Create a placeholder 256x256 PNG
          sudo apt-get install -y imagemagick 2>/dev/null || true
          convert -size 256x256 xc:blue -fill white -pointsize 72 -gravity center \
            -annotate +0+0 "TL" AppDir/usr/share/icons/hicolor/256x256/apps/turnlab.png 2>/dev/null || \
          echo "No icon - will use default"
        fi

    - name: Download linuxdeploy and Qt plugin
      run: |
        wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
        chmod +x linuxdeploy*.AppImage
        # Extract AppImages to avoid FUSE issues
        ./linuxdeploy-x86_64.AppImage --appimage-extract
        ./linuxdeploy-plugin-qt-x86_64.AppImage --appimage-extract
        mv squashfs-root linuxdeploy-squashfs
        mv squashfs-root-1 linuxdeploy-plugin-qt-squashfs

    - name: Build AppImage
      run: |
        export QMAKE=/usr/bin/qmake6
        export QT_ROOT_DIR=/usr
        export LD_LIBRARY_PATH=/usr/local/qwt-6.3.1-dev/lib:$LD_LIBRARY_PATH
        export OUTPUT=TurnLab-x86_64.AppImage
        # Copy QWT library
        mkdir -p AppDir/usr/lib
        cp -P /usr/local/qwt-6.3.1-dev/lib/libqwt.so* AppDir/usr/lib/
        # Run linuxdeploy with Qt plugin
        ./linuxdeploy-squashfs/AppRun --appdir AppDir --plugin qt --output appimage

    - name: Upload AppImage
      uses: actions/upload-artifact@v4
      with:
        name: TurnLab-AppImage
        path: '*.AppImage'